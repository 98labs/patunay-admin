-- Sample Data Creation Script for Multi-Tenant RBAC Testing
-- This script creates sample organizations, users, and permissions for testing

-- ============================================================================
-- 1. CREATE SAMPLE ORGANIZATIONS
-- ============================================================================

INSERT INTO public.organizations (name, type, description, contact_email, website, is_active) VALUES
('Metropolitan Art Gallery', 'gallery', 'Premier contemporary art gallery in downtown', 'info@metroartgallery.com', 'https://metroartgallery.com', true),
('City Museum of Fine Arts', 'museum', 'Public museum showcasing classical and modern art', 'contact@citymuseum.org', 'https://citymuseum.org', true),
('Jackson Miller Studio', 'artist', 'Independent artist studio specializing in sculptures', 'jackson@millerstudio.com', 'https://jacksonmiller.art', true),
('Heritage Private Collection', 'collector', 'Private collection focusing on 19th century paintings', 'curator@heritagecollection.com', null, true),
('Premier Auction House', 'auction_house', 'High-end art auction and appraisal services', 'auctions@premierauction.com', 'https://premierauction.com', true);

-- ============================================================================
-- 2. CREATE SAMPLE USERS
-- ============================================================================

-- Note: In a real environment, these would be created through the auth system
-- This is just for demonstration of the database structure

-- Get organization IDs for reference
DO $$
DECLARE
    metro_gallery_id uuid;
    city_museum_id uuid;
    miller_studio_id uuid;
    heritage_collection_id uuid;
    premier_auction_id uuid;
    default_org_id uuid;
BEGIN
    -- Get organization IDs
    SELECT id INTO metro_gallery_id FROM public.organizations WHERE name = 'Metropolitan Art Gallery';
    SELECT id INTO city_museum_id FROM public.organizations WHERE name = 'City Museum of Fine Arts';
    SELECT id INTO miller_studio_id FROM public.organizations WHERE name = 'Jackson Miller Studio';
    SELECT id INTO heritage_collection_id FROM public.organizations WHERE name = 'Heritage Private Collection';
    SELECT id INTO premier_auction_id FROM public.organizations WHERE name = 'Premier Auction House';
    SELECT id INTO default_org_id FROM public.organizations WHERE name = 'Default Organization';

    -- Sample user UUIDs (these would normally be generated by Supabase Auth)
    -- Super User
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('11111111-1111-1111-1111-111111111111', 'Alice', 'Anderson', 'super_user', null, true, '+1-555-0101', now());

    -- Gallery Admin
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('22222222-2222-2222-2222-222222222222', 'Bob', 'Williams', 'admin', metro_gallery_id, true, '+1-555-0102', now());

    -- Museum Admin
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('33333333-3333-3333-3333-333333333333', 'Carol', 'Davis', 'admin', city_museum_id, true, '+1-555-0103', now());

    -- Independent Issuer (Artist)
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('44444444-4444-4444-4444-444444444444', 'David', 'Miller', 'issuer', miller_studio_id, true, '+1-555-0104', now());

    -- Independent Appraiser
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('55555555-5555-5555-5555-555555555555', 'Emma', 'Thompson', 'appraiser', premier_auction_id, true, '+1-555-0105', now());

    -- Gallery Staff
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('66666666-6666-6666-6666-666666666666', 'Frank', 'Garcia', 'staff', metro_gallery_id, true, '+1-555-0106', now());

    -- Museum Staff
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('77777777-7777-7777-7777-777777777777', 'Grace', 'Martinez', 'staff', city_museum_id, true, '+1-555-0107', now());

    -- Viewer (Collector's Assistant)
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('88888888-8888-8888-8888-888888888888', 'Henry', 'Rodriguez', 'viewer', heritage_collection_id, true, '+1-555-0108', now());

    -- Additional Gallery Staff with different role
    INSERT INTO public.profiles (id, first_name, last_name, role, organization_id, is_active, phone, created_at) VALUES
    ('99999999-9999-9999-9999-999999999999', 'Isabel', 'Wilson', 'staff', metro_gallery_id, true, '+1-555-0109', now());

    -- ============================================================================
    -- 3. CREATE ORGANIZATION MEMBERSHIPS
    -- ============================================================================

    -- Super User (can belong to any organization, but we'll add them to a few)
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (metro_gallery_id, '11111111-1111-1111-1111-111111111111', 'super_user', false, true, '{}'),
    (city_museum_id, '11111111-1111-1111-1111-111111111111', 'super_user', false, true, '{}'),
    (default_org_id, '11111111-1111-1111-1111-111111111111', 'super_user', true, true, '{}');

    -- Gallery Admin
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (metro_gallery_id, '22222222-2222-2222-2222-222222222222', 'admin', true, true, '{}');

    -- Museum Admin
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (city_museum_id, '33333333-3333-3333-3333-333333333333', 'admin', true, true, '{}');

    -- Artist/Issuer
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (miller_studio_id, '44444444-4444-4444-4444-444444444444', 'issuer', true, true, '{}');

    -- Appraiser
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (premier_auction_id, '55555555-5555-5555-5555-555555555555', 'appraiser', true, true, '{}');

    -- Gallery Staff
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (metro_gallery_id, '66666666-6666-6666-6666-666666666666', 'staff', true, true, '{}');

    -- Museum Staff
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (city_museum_id, '77777777-7777-7777-7777-777777777777', 'staff', true, true, '{}');

    -- Viewer
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (heritage_collection_id, '88888888-8888-8888-8888-888888888888', 'viewer', true, true, '{}');

    -- Additional Gallery Staff
    INSERT INTO public.organization_users (organization_id, user_id, role, is_primary, is_active, permissions) VALUES
    (metro_gallery_id, '99999999-9999-9999-9999-999999999999', 'staff', true, true, '{}');

    -- ============================================================================
    -- 4. CREATE CROSS-ORGANIZATIONAL PERMISSIONS
    -- ============================================================================

    -- Give the appraiser access to appraise artworks for multiple organizations
    INSERT INTO public.cross_org_permissions (user_id, organization_id, permission_type, permissions, is_active, notes, created_by) VALUES
    ('55555555-5555-5555-5555-555555555555', metro_gallery_id, 'appraiser_access', 
     '{"create_appraisals", "update_appraisals", "view_artwork_details"}', 
     true, 'Contracted appraiser for gallery exhibitions', '22222222-2222-2222-2222-222222222222'),
    
    ('55555555-5555-5555-5555-555555555555', city_museum_id, 'appraiser_access', 
     '{"create_appraisals", "update_appraisals", "view_artwork_details"}', 
     true, 'Museum appraisal services contract', '33333333-3333-3333-3333-333333333333'),
     
    ('55555555-5555-5555-5555-555555555555', heritage_collection_id, 'appraiser_access', 
     '{"create_appraisals", "update_appraisals", "view_artwork_details"}', 
     true, 'Private collection valuation services', '88888888-8888-8888-8888-888888888888');

    -- Give the artist/issuer permission to issue NFC tags for galleries that showcase their work
    INSERT INTO public.cross_org_permissions (user_id, organization_id, permission_type, permissions, is_active, notes, created_by) VALUES
    ('44444444-4444-4444-4444-444444444444', metro_gallery_id, 'issuer_access', 
     '{"manage_nfc_tags", "attach_nfc_tags", "create_artworks"}', 
     true, 'Artist can tag own works displayed at gallery', '22222222-2222-2222-2222-222222222222'),
     
    ('44444444-4444-4444-4444-444444444444', city_museum_id, 'issuer_access', 
     '{"manage_nfc_tags", "attach_nfc_tags", "create_artworks"}', 
     true, 'Artist exhibition at museum', '33333333-3333-3333-3333-333333333333');

    -- ============================================================================
    -- 5. CREATE SAMPLE ARTWORKS WITH ORGANIZATION CONTEXT
    -- ============================================================================

    -- Gallery artworks
    INSERT INTO public.artworks (title, description, artist, year, medium, organization_id, created_by, id_number) VALUES
    ('Sunset Boulevard', 'Contemporary urban landscape painting', 'Marina Rodriguez', '2023', 'Oil on canvas', metro_gallery_id, '22222222-2222-2222-2222-222222222222', 'MG-2023-001'),
    ('Digital Dreams', 'Abstract digital art piece exploring technology themes', 'Alex Chen', '2024', 'Digital print', metro_gallery_id, '66666666-6666-6666-6666-666666666666', 'MG-2024-001'),
    ('Memory Palace', 'Installation piece about forgotten histories', 'Sarah Johnson', '2023', 'Mixed media installation', metro_gallery_id, '22222222-2222-2222-2222-222222222222', 'MG-2023-002');

    -- Museum artworks
    INSERT INTO public.artworks (title, description, artist, year, medium, organization_id, created_by, id_number) VALUES
    ('Classical Harmony', 'Renaissance-style painting depicting musical themes', 'Antonio Vivaldi Jr.', '1890', 'Oil on canvas', city_museum_id, '33333333-3333-3333-3333-333333333333', 'CM-1890-001'),
    ('Industrial Revolution', 'Historical documentation of 19th century machinery', 'William Hartley', '1885', 'Charcoal and ink', city_museum_id, '77777777-7777-7777-7777-777777777777', 'CM-1885-001');

    -- Artist studio works
    INSERT INTO public.artworks (title, description, artist, year, medium, organization_id, created_by, id_number) VALUES
    ('Eternal Forms', 'Large bronze sculpture exploring organic shapes', 'David Miller', '2024', 'Bronze sculpture', miller_studio_id, '44444444-4444-4444-4444-444444444444', 'DM-2024-001'),
    ('Wind Patterns', 'Kinetic sculpture responding to air movement', 'David Miller', '2023', 'Steel and aluminum', miller_studio_id, '44444444-4444-4444-4444-444444444444', 'DM-2023-001');

    -- Private collection
    INSERT INTO public.artworks (title, description, artist, year, medium, organization_id, created_by, id_number) VALUES
    ('Portrait of Lady Margaret', 'Victorian era portrait painting', 'Edward Burlington', '1875', 'Oil on canvas', heritage_collection_id, '88888888-8888-8888-8888-888888888888', 'HC-1875-001'),
    ('Garden at Twilight', 'Impressionist landscape painting', 'Claude Monet', '1892', 'Oil on canvas', heritage_collection_id, '88888888-8888-8888-8888-888888888888', 'HC-1892-001');

    -- ============================================================================
    -- 6. CREATE SAMPLE NFC TAGS
    -- ============================================================================

    -- Gallery tags
    INSERT INTO public.tags (id, organization_id, created_by, active) VALUES
    ('METRO001', metro_gallery_id, '22222222-2222-2222-2222-222222222222', true),
    ('METRO002', metro_gallery_id, '66666666-6666-6666-6666-666666666666', true),
    ('METRO003', metro_gallery_id, '22222222-2222-2222-2222-222222222222', true);

    -- Museum tags
    INSERT INTO public.tags (id, organization_id, created_by, active) VALUES
    ('MUSEUM001', city_museum_id, '33333333-3333-3333-3333-333333333333', true),
    ('MUSEUM002', city_museum_id, '77777777-7777-7777-7777-777777777777', true);

    -- Artist studio tags
    INSERT INTO public.tags (id, organization_id, created_by, active) VALUES
    ('ARTIST001', miller_studio_id, '44444444-4444-4444-4444-444444444444', true),
    ('ARTIST002', miller_studio_id, '44444444-4444-4444-4444-444444444444', true);

    -- ============================================================================
    -- 7. CREATE SAMPLE APPRAISALS
    -- ============================================================================

    -- Get artwork IDs for appraisals
    DECLARE
        artwork_id_1 uuid;
        artwork_id_2 uuid;
        artwork_id_3 uuid;
    BEGIN
        SELECT id INTO artwork_id_1 FROM public.artworks WHERE title = 'Portrait of Lady Margaret';
        SELECT id INTO artwork_id_2 FROM public.artworks WHERE title = 'Sunset Boulevard';
        SELECT id INTO artwork_id_3 FROM public.artworks WHERE title = 'Classical Harmony';

        -- Create sample appraisals
        INSERT INTO public.artwork_appraisals (artwork_id, condition, acquisition_cost, appraised_value, artist_info, notes, recommendation, appraisal_date, created_by) VALUES
        (artwork_id_1, 'Excellent condition, original frame intact', 15000.00, 45000.00, 'Edward Burlington (1840-1895) - Notable Victorian portrait artist', 'Exceptional provenance and condition. Recommend for insurance at full appraised value.', 'Insure for full appraised value, display in controlled environment', '2024-01-15', '55555555-5555-5555-5555-555555555555'),
        
        (artwork_id_2, 'Good condition, minor surface dust', 8000.00, 12000.00, 'Marina Rodriguez - Contemporary artist with growing reputation', 'Strong composition and technique. Market value increasing.', 'Good investment piece, suitable for exhibition', '2024-02-10', '55555555-5555-5555-5555-555555555555'),
        
        (artwork_id_3, 'Fair condition, requires conservation', 25000.00, 35000.00, 'Antonio Vivaldi Jr. - Son of famous composer, lesser-known painter', 'Historical significance, but condition affects value. Conservation recommended.', 'Professional conservation needed before exhibition', '2024-01-20', '55555555-5555-5555-5555-555555555555');
    END;

    RAISE NOTICE 'Sample data creation completed successfully!';
    RAISE NOTICE 'Created:';
    RAISE NOTICE '- 5 organizations (gallery, museum, artist studio, private collection, auction house)';
    RAISE NOTICE '- 9 users with different roles (super_user, admin, issuer, appraiser, staff, viewer)';
    RAISE NOTICE '- Organization memberships and cross-org permissions';
    RAISE NOTICE '- 9 sample artworks across different organizations';
    RAISE NOTICE '- 7 NFC tags';
    RAISE NOTICE '- 3 sample appraisals';
    RAISE NOTICE '';
    RAISE NOTICE 'Sample Users:';
    RAISE NOTICE '- Alice Anderson (Super User)';
    RAISE NOTICE '- Bob Williams (Gallery Admin)';
    RAISE NOTICE '- Carol Davis (Museum Admin)';
    RAISE NOTICE '- David Miller (Artist/Issuer)';
    RAISE NOTICE '- Emma Thompson (Appraiser)';
    RAISE NOTICE '- Frank Garcia (Gallery Staff)';
    RAISE NOTICE '- Grace Martinez (Museum Staff)';
    RAISE NOTICE '- Henry Rodriguez (Viewer)';
    RAISE NOTICE '- Isabel Wilson (Additional Gallery Staff)';

END $$;